# 函数表达式：涉及大量概念，函数表达式到底该怎么学？

使用函数表达式可以用来实现代码隐藏，还可以实现变量隔离。

函数表达式和函数声明看起来类似，都是定义一个函数，然后再调用该函数，很容易把二者搞混淆了。

## 函数声明与函数表达式的差异

```js
// 作用域中存在foo函数
foo()

// 函数声明
function foo () {
  console.log('foo')
}
```

```js
// 作用域中 foo 为 undefined, 所以执行的时候报错
foo()

// 函数表达式
var foo = function () {
  console.log('foo')
}
```

## V8 是怎么处理函数声明的？

V8 在执行 JavaScript 的过程中，会先对其进行编译，然后再执行。

在编译阶段，如果解析到函数声明，那么 V8 会将这个函数声明转换为内存中的函数对象，并将其放到作用域中。同样，如果解析到了某个变量声明，也会将其放到作用域中，但是会将其值设置为 undefined，表示该变量还未被使用。

然后在 V8 执行阶段，如果使用了某个变量，或者调用了某个函数，那么 V8 便会去作用域查找相关内容。

我们把这种在编译阶段，将所有的变量提升到作用域的过程称为`变量提升`。

### 为什么可以在函数声明之前调用该函数?

这是因为声明的函数在编译阶段就被提升到作用域中，在执行阶段，只要是在作用域中存在的变量或者对象，都是可以使用的。

### 对于变量提升，函数和普通的对象还是存在一些差异的。

如果是一个普通变量，变量提升之后的值都是 undefined，如果是声明的函数，那么变量提升之后的值则是函数对象。

```js
var x = undefined // 声明
x = 5 // 表达式 执行表达式会返回一个值
```

首先，在变量提升阶段，V8 并不会执行赋值的表达式，该阶段只会分析基础的语句，比如变量的定义，函数的声明。

而这两行代码是在不同的阶段完成的，var x 是在编译阶段完成的，也可以说是在变量提升阶段完成的，

而x = 5是表达式，所有的表达式都是在执行阶段完成的。

在变量提升阶段，V8 将这些变量存放在作用域时，还会给它们赋一个默认的 undefined 值，所以在定义一个普通的变量之前，使用该变量，那么该变量的值就是 undefined。

所以表达式是不会在编译阶段执行的。

那么函数声明是表达式还是语句呢？你可以看下面这段函数声明：

```js
function foo () {
  console.log('Foo')
}
```

执行上面这段代码，它并没有输出任何内容，所以可以肯定，函数声明并不是一个表达式，而是一个语句。

V8 在变量提升阶段，如果遇到函数声明，那么 V8 同样会对该函数声明执行变量提升操作。

函数也是一个对象，所以在编译阶段，V8 就会将整个函数对象提升到作用域中，并不是给该函数名称赋一个 undefined，理解这一点尤为重要。

### 总结

在 V8 解析 JavaScript 源码的过程中，

- 如果遇到普通的变量声明，那么便会将其提升到作用域中，并给该变量赋值为 undefined。
- 如果遇到的是函数声明，那么 V8 会在内存中为声明生成函数对象，并将该对象提升到作用域中。

## V8 是怎么处理函数表达式的？

> 我们在一个表达式中使用 function 来定义一个函数，那么就把该函数称为函数表达式。


函数表达式与函数声明的`最主要区别`有以下三点：

- 函数表达式是在表达式语句中使用 function 的，最典型的表达式是“a=b”这种形式，因为函数也是一个对象，我们把“a = function (){}”这种方式称为函数表达式；
- 在函数表达式中，可以省略函数名称，从而创建匿名函数（anonymous functions）；
- 一个函数表达式可以被用作一个即时调用的函数表达式——IIFE（Immediately Invoked Function Expression）。

```js
foo()
var foo = function () {
  console.log('foo')
}
```

当执行这段代码的时候，V8 在编译阶段会先查找声明语句，你可以把这段代码拆分为下面两行代码：

```js
var foo = undefined

foo = function () {
  console.log('foo')
}
```

第一行是声明语句，所以 V8 在解析阶段，就会在作用域中创建该对象，并将该对象设置为 undefined，

第二行是函数表达式，在编译阶段，V8 并不会处理函数表达式，所以也就不会将该函数表达式提升到作用域中了。

那么在函数表达式之前调用该函数 foo，此时的 foo 只是指向了 undefined，所以就相当于调用一个 undefined，而 undefined 只是一个原生对象，并不是函数，所以当然会报错了。

## 立即调用的函数表达式（IIFE）

### 好处

不会污染环境，函数和函数内部的变量都不会被其他部分的代码访问到。

## 总结

- 函数声明的本质是语句，而函数表达式的本质则是表达式。
- 函数声明和变量声明类似
    - 在编译阶段，都会对其执行变量提升的操作，将它们提升到作用域中，`同名的话，函数声明的优先级最高`
    - 在执行阶段，如果使用了某个变量，就可以直接去作用域中去查找。不过 V8 对于提升函数和提升变量的策略是不同的
        - 变量，那么 V8 在将变量提升到作用域中时，还会为其设置默认值 undefined，
        - 函数声明，那么 V8 会在内存中创建该函数对象，并提升整个函数对象。
        - 函数表达式也是表达式的一种，在编译阶段，V8 并不会将表达式中的函数对象提升到全局作用域中，所以无法在函数表达式之前使用该函数。
        - 函数立即表达式是一种特别的表达式，主要用来封装一些变量、函数，可以起到变量隔离和代码隐藏的作用。